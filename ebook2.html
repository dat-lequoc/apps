<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPUB Reader</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            height: 100vh;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }
        
        /* Theme classes */
        body.light-theme {
            background-color: #f9f9f9;
            color: #333;
        }
        
        body.sepia-theme {
            background-color: #f8f1e3;
            color: #5f4b32;
        }
        
        body.dark-theme {
            background-color: #333;
            color: #e0e0e0;
        }
        
        /* Initial welcome screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-screen h2 {
            margin-bottom: 20px;
        }
        
        .open-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .recent-files {
            margin-top: 30px;
            width: 100%;
            max-width: 320px;
        }
        
        .recent-file-item {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Navbar */
        .navbar {
            position: fixed;
            top: -60px;
            left: 0;
            right: 0;
            height: 60px;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: top 0.3s ease;
            z-index: 100;
        }
        
        .navbar.visible {
            top: 0;
        }
        
        .navbar-title {
            font-size: 18px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 50%;
        }
        
        .navbar-buttons {
            display: flex;
            gap: 15px;
        }
        
        .navbar-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .toc-btn {
            background-color: #FFC107;
        }
        
        .settings-btn {
            background-color: #F44336;
        }
        
        .home-btn {
            background-color: #2196F3;
        }
        
        /* Side panels */
        .panel {
            position: fixed;
            background-color: white;
            z-index: 200;
            transition: transform 0.3s ease;
        }
        
        .toc-panel {
            top: 0;
            left: 0;
            height: 100%;
            width: 80%;
            max-width: 320px;
            transform: translateX(-100%);
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .toc-panel.visible {
            transform: translateX(0);
        }
        
        .toc-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .toc-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .settings-panel {
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            transform: translateY(100%);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        
        .settings-panel.visible {
            transform: translateY(0);
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.4);
            z-index: 150;
            display: none;
        }
        
        .panel-overlay.visible {
            display: block;
        }
        
        /* Settings controls */
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .font-size-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .font-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background-color: white;
            font-weight: bold;
            cursor: pointer;
        }
        
        .theme-options {
            display: flex;
            gap: 15px;
        }
        
        .theme-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .theme-option.active {
            border-color: #2196F3;
        }
        
        .light-option {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }
        
        .sepia-option {
            background-color: #f8f1e3;
        }
        
        .dark-option {
            background-color: #333;
        }
        
        /* Reader content */
        .reader-container {
            height: 100vh;
            position: relative;
            overflow: hidden;
        }
        
        .content-container {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            transition: background-color 0.3s ease;
        }
        
        body.light-theme .content-container {
            background-color: white;
        }
        
        body.sepia-theme .content-container {
            background-color: #f8f1e3;
        }
        
        body.dark-theme .content-container {
            background-color: #222;
            color: #e0e0e0;
        }
        
        /* Navigation arrows */
        .nav-arrows {
            position: absolute;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            pointer-events: none;
        }
        
        .nav-arrow {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: auto;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 75;
            position: relative;
        }
        
        /* Progress indicator */
        .progress-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .progress-indicator.visible {
            opacity: 1;
        }
        
        /* Touch zones */
        .touch-zone {
            position: absolute;
            z-index: 50;
        }
        
        .zone-top {
            top: 0;
            left: 0;
            right: 0;
            height: 80px;
        }
        
        .zone-left {
            left: 0;
            top: 80px;
            bottom: 0;
            width: 40%;
        }
        
        .zone-right {
            right: 0;
            top: 80px;
            bottom: 0;
            width: 40%;
        }
        
        /* Hide initial elements that will be replaced */
        header, .file-input, .reader-controls, .info, .toc-container, .footnote {
            display: none;
        }
        
        /* Additional mobile optimizations */
        @media (max-width: 768px) {
            .navbar-title {
                max-width: 40%;
            }
            
            .toc-panel {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <!-- Original elements (hidden but preserved for functionality) -->
    <header>
        <h1>EPUB Reader</h1>
        <div class="file-input">
            <input type="file" id="epub-file" accept=".epub" />
            <button id="load-button">Load EPUB</button>
        </div>
    </header>
    
    <div class="info" id="book-info">
        <!-- Book metadata will be displayed here -->
    </div>
    
    <div class="reader-controls">
        <button id="prev-button" disabled>Previous Chapter</button>
        <button id="toc-button" disabled>Table of Contents</button>
        <button id="next-button" disabled>Next Chapter</button>
    </div>
    
    <div class="toc-container" id="toc-container">
        <ul class="toc-list" id="toc-list"></ul>
    </div>
    
    <!-- New mobile-optimized UI elements -->
    <div class="welcome-screen" id="welcome-screen">
        <h2>EPUB Reader</h2>
        <p>Tap below to open an EPUB file</p>
        <button class="open-button" id="open-epub-button">Open EPUB</button>
        
        <div class="recent-files" id="recent-files">
            <h3>Recent Books</h3>
            <!-- Recent files will be populated here -->
        </div>
    </div>
    
    <div class="reader-container" id="reader-container" style="display: none;">
        <!-- Top navbar -->
        <div class="navbar" id="navbar">
            <div class="navbar-title" id="navbar-title">Book Title</div>
            <div class="navbar-buttons">
                <button class="navbar-button toc-btn" id="toc-btn">
                    ☰
                </button>
                <button class="navbar-button settings-btn" id="settings-btn">
                    ⚙
                </button>
                <button class="navbar-button home-btn" id="home-btn">
                    ⌂
                </button>
            </div>
        </div>
        
        <!-- Touch zones -->
        <div class="touch-zone zone-top" id="zone-top"></div>
        <div class="touch-zone zone-left" id="zone-left"></div>
        <div class="touch-zone zone-right" id="zone-right"></div>
        
        <!-- Content container -->
        <div class="content-container" id="content">
            <div class="loading">Upload an EPUB file to start reading</div>
        </div>
        
        <!-- Navigation arrows -->
        <div class="nav-arrows">
            <div class="nav-arrow" id="prev-arrow">←</div>
            <div class="nav-arrow" id="next-arrow">→</div>
        </div>
        
        <!-- Progress indicator -->
        <div class="progress-indicator" id="progress-indicator">45%</div>
    </div>
    
    <!-- Table of Contents panel -->
    <div class="panel toc-panel" id="toc-panel">
        <div class="toc-header">
            <h3>Table of Contents</h3>
            <button id="close-toc">✕</button>
        </div>
        <div class="toc-content" id="toc-content"></div>
    </div>
    
    <!-- Settings panel -->
    <div class="panel settings-panel" id="settings-panel">
        <div class="settings-section">
            <div class="settings-title">Font Size</div>
            <div class="font-size-controls">
                <button class="font-button" id="font-decrease">A-</button>
                <span id="font-size-value">100%</span>
                <button class="font-button" id="font-increase">A+</button>
            </div>
        </div>
        
        <div class="settings-section">
            <div class="settings-title">Theme</div>
            <div class="theme-options">
                <div class="theme-option light-option active" data-theme="light"></div>
                <div class="theme-option sepia-option" data-theme="sepia"></div>
                <div class="theme-option dark-option" data-theme="dark"></div>
            </div>
        </div>
    </div>
    
    <!-- Panel overlay -->
    <div class="panel-overlay" id="panel-overlay"></div>

    <script>
        // Main elements
        const fileInput = document.getElementById('epub-file');
        const loadButton = document.getElementById('load-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const tocButton = document.getElementById('toc-button');
        const tocContainer = document.getElementById('toc-container');
        const tocList = document.getElementById('toc-list');
        const contentContainer = document.getElementById('content');
        const bookInfo = document.getElementById('book-info');
        
        // EPUB data storage
        let epub = {
            content: {},
            spine: [],
            toc: [],
            metadata: {},
            currentChapterIndex: 0
        };
        
        // New UI References
        const welcomeScreen = document.getElementById('welcome-screen');
        const readerContainer = document.getElementById('reader-container');
        const openEpubButton = document.getElementById('open-epub-button');
        const navbar = document.getElementById('navbar');
        const navbarTitle = document.getElementById('navbar-title');
        const tocBtn = document.getElementById('toc-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const homeBtn = document.getElementById('home-btn');
        const tocPanel = document.getElementById('toc-panel');
        const closeTocBtn = document.getElementById('close-toc');
        const tocContent = document.getElementById('toc-content');
        const settingsPanel = document.getElementById('settings-panel');
        const panelOverlay = document.getElementById('panel-overlay');
        const progressIndicator = document.getElementById('progress-indicator');
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const fontIncreaseBtn = document.getElementById('font-increase');
        const fontSizeValue = document.getElementById('font-size-value');
        const themeOptions = document.querySelectorAll('.theme-option');
        const zoneTop = document.getElementById('zone-top');
        const zoneLeft = document.getElementById('zone-left');
        const zoneRight = document.getElementById('zone-right');
        const prevArrow = document.getElementById('prev-arrow');
        const nextArrow = document.getElementById('next-arrow');
        
        // Event listeners
        loadButton.addEventListener('click', handleFileSelection);
        prevButton.addEventListener('click', navigateToPreviousChapter);
        nextButton.addEventListener('click', navigateToNextChapter);
        tocButton.addEventListener('click', toggleTableOfContents);
        
        // Add event listeners for new UI
        openEpubButton.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Handle file selected after clicking the open button
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFileSelection();
                welcomeScreen.style.display = 'none';
                readerContainer.style.display = 'block';
            }
        });
        
        // Touch zones for navigation
        zoneTop.addEventListener('click', toggleNavbar);
        
        // Navbar buttons
        tocBtn.addEventListener('click', showTocPanel);
        settingsBtn.addEventListener('click', showSettingsPanel);
        homeBtn.addEventListener('click', returnToHome);
        closeTocBtn.addEventListener('click', hideTocPanel);
        
        // Panel overlay (used to close panels when clicking outside)
        panelOverlay.addEventListener('click', closeAllPanels);
        
        // Navigation arrows
        prevArrow.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            navigateToPreviousChapter();
        });
        
        nextArrow.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            navigateToNextChapter();
        });
        
        // Font size controls
        fontDecreaseBtn.addEventListener('click', decreaseFontSize);
        fontIncreaseBtn.addEventListener('click', increaseFontSize);
        
        // Theme options
        themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                setTheme(option.dataset.theme);
            });
        });
        
        // Variable to store the current font size percentage
        let currentFontSize = 100;
        let currentTheme = 'light';
        
        // Handle file upload
        function handleFileSelection() {
            const file = fileInput.files[0];
            if (!file || file.type !== 'application/epub+zip') {
                alert('Please select a valid EPUB file.');
                return;
            }
            
            contentContainer.innerHTML = '<div class="loading">Loading EPUB...</div>';
            resetEpubState();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseEpub(e.target.result);
            };
            reader.onerror = function() {
                contentContainer.innerHTML = '<div class="loading">Error reading file.</div>';
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Parse the EPUB file
        function parseEpub(arrayBuffer) {
            const jszip = new JSZip();
            
            jszip.loadAsync(arrayBuffer)
                .then(function(zip) {
                    // First, get the container.xml to find the OPF file
                    return zip.file('META-INF/container.xml').async('text');
                })
                .then(function(containerXml) {
                    const parser = new DOMParser();
                    const containerDoc = parser.parseFromString(containerXml, 'application/xml');
                    const rootFilePath = containerDoc.querySelector('rootfile').getAttribute('full-path');
                    
                    // Store the root directory for resolving relative paths
                    epub.rootDirectory = rootFilePath.substring(0, rootFilePath.lastIndexOf('/') + 1);
                    
                    // Get the OPF file
                    return jszip.file(rootFilePath).async('text');
                })
                .then(function(opfContent) {
                    const parser = new DOMParser();
                    const opfDoc = parser.parseFromString(opfContent, 'application/xml');
                    
                    // Parse metadata
                    parseMetadata(opfDoc);
                    
                    // Parse manifest items
                    const manifest = opfDoc.querySelector('manifest');
                    const manifestItems = {};
                    
                    manifest.querySelectorAll('item').forEach(item => {
                        const id = item.getAttribute('id');
                        const href = item.getAttribute('href');
                        const mediaType = item.getAttribute('media-type');
                        
                        manifestItems[id] = {
                            href: href,
                            mediaType: mediaType
                        };
                    });
                    
                    // Parse spine
                    const spine = opfDoc.querySelector('spine');
                    const spineItems = [];
                    
                    spine.querySelectorAll('itemref').forEach(itemref => {
                        const idref = itemref.getAttribute('idref');
                        if (manifestItems[idref]) {
                            spineItems.push({
                                id: idref,
                                href: manifestItems[idref].href,
                                mediaType: manifestItems[idref].mediaType
                            });
                        }
                    });
                    
                    epub.spine = spineItems;
                    
                    // Parse TOC (NavPoint)
                    const tocId = spine.getAttribute('toc');
                    if (tocId && manifestItems[tocId]) {
                        const tocPath = manifestItems[tocId].href;
                        return {
                            zip: jszip,
                            tocPath: tocPath,
                            manifestItems: manifestItems
                        };
                    } else {
                        // Try to find the nav document (EPUB3)
                        let navItem = Object.values(manifestItems).find(item => 
                            item.mediaType === 'application/xhtml+xml' && 
                            item.href.includes('nav') || item.href.includes('toc'));
                        
                        if (navItem) {
                            return {
                                zip: jszip,
                                tocPath: navItem.href,
                                manifestItems: manifestItems
                            };
                        } else {
                            return {
                                zip: jszip,
                                tocPath: null,
                                manifestItems: manifestItems
                            };
                        }
                    }
                })
                .then(function(data) {
                    const {zip, tocPath, manifestItems} = data;
                    
                    // If we found a TOC, parse it
                    if (tocPath) {
                        const fullTocPath = epub.rootDirectory + tocPath;
                        return zip.file(fullTocPath).async('text').then(tocContent => {
                            const parser = new DOMParser();
                            const tocDoc = parser.parseFromString(tocContent, 'application/xml');
                            
                            // Try parsing as NCX (EPUB2)
                            let navPoints = tocDoc.querySelectorAll('navPoint');
                            if (navPoints.length > 0) {
                                parseTocFromNavPoints(navPoints);
                            } else {
                                // Try parsing as EPUB3 nav
                                let navLinks = tocDoc.querySelectorAll('nav[epub\\:type="toc"] a, nav[*|type="toc"] a');
                                if (navLinks.length > 0) {
                                    parseTocFromNavLinks(navLinks);
                                }
                            }
                            
                            return {zip, manifestItems};
                        }).catch(() => {
                            // If TOC parsing fails, continue without TOC
                            return {zip, manifestItems};
                        });
                    } else {
                        return {zip, manifestItems};
                    }
                })
                .then(function(data) {
                    const {zip} = data;
                    
                    // Load all spine items
                    const loadPromises = epub.spine.map(item => {
                        const fullPath = epub.rootDirectory + item.href;
                        return zip.file(fullPath).async('text').then(content => {
                            epub.content[item.id] = content;
                        }).catch(error => {
                            console.error(`Failed to load ${fullPath}:`, error);
                        });
                    });
                    
                    return Promise.all(loadPromises).then(() => zip);
                })
                .then(function(zip) {
                    // Enable navigation buttons
                    enableNavigationButtons();
                    
                    // Display metadata
                    displayMetadata();
                    
                    // Display first chapter
                    navigateToChapter(0);
                })
                .catch(function(error) {
                    console.error('Error parsing EPUB:', error);
                    contentContainer.innerHTML = '<div class="loading">Error parsing EPUB. Make sure the file is a valid EPUB.</div>';
                });
        }
        
        // Parse metadata from the OPF document
        function parseMetadata(opfDoc) {
            const metadataElement = opfDoc.querySelector('metadata');
            if (!metadataElement) return;
            
            // Title
            const titleElement = metadataElement.querySelector('dc\\:title, title');
            if (titleElement) {
                epub.metadata.title = titleElement.textContent;
            }
            
            // Creator/Author
            const creatorElement = metadataElement.querySelector('dc\\:creator, creator');
            if (creatorElement) {
                epub.metadata.creator = creatorElement.textContent;
            }
            
            // Language
            const languageElement = metadataElement.querySelector('dc\\:language, language');
            if (languageElement) {
                epub.metadata.language = languageElement.textContent;
            }
        }
        
        // Parse TOC from NavPoints (EPUB2)
        function parseTocFromNavPoints(navPoints) {
            const processTocItems = (nodes, level = 0) => {
                let items = [];
                
                Array.from(nodes).forEach(navPoint => {
                    const label = navPoint.querySelector('navLabel text').textContent;
                    const content = navPoint.querySelector('content');
                    const src = content ? content.getAttribute('src') : '';
                    
                    // Extract the spine ID from the src
                    let targetPath = src.split('#')[0];
                    let fragmentId = src.includes('#') ? src.split('#')[1] : null;
                    
                    // Find the matching spine item
                    let spineIndex = epub.spine.findIndex(item => 
                        item.href.endsWith(targetPath) || targetPath.endsWith(item.href));
                    
                    if (spineIndex !== -1) {
                        const tocItem = {
                            label: label,
                            spineIndex: spineIndex,
                            fragmentId: fragmentId,
                            level: level
                        };
                        
                        const subItems = navPoint.querySelectorAll(':scope > navPoint');
                        if (subItems.length > 0) {
                            tocItem.subitems = processTocItems(subItems, level + 1);
                        }
                        
                        items.push(tocItem);
                    }
                });
                
                return items;
            };
            
            epub.toc = processTocItems(navPoints);
        }
        
        // Parse TOC from Nav Links (EPUB3)
        function parseTocFromNavLinks(navLinks) {
            const tocItems = [];
            
            navLinks.forEach(link => {
                const label = link.textContent.trim();
                const href = link.getAttribute('href');
                
                if (href) {
                    // Extract the file path and fragment ID
                    let targetPath = href.split('#')[0];
                    let fragmentId = href.includes('#') ? href.split('#')[1] : null;
                    
                    // If target path is empty, it's pointing to the current file
                    if (targetPath === '') {
                        targetPath = link.closest('html').querySelector('head > link[rel="self"]')?.getAttribute('href') || '';
                    }
                    
                    // Find the matching spine item
                    let spineIndex = epub.spine.findIndex(item => 
                        item.href.endsWith(targetPath) || targetPath.endsWith(item.href));
                    
                    if (spineIndex !== -1) {
                        tocItems.push({
                            label: label,
                            spineIndex: spineIndex,
                            fragmentId: fragmentId,
                            level: getElementNestLevel(link, 'nav')
                        });
                    }
                }
            });
            
            epub.toc = tocItems;
        }
        
        // Helper to get element nesting level for EPUB3 TOC
        function getElementNestLevel(element, topTagName) {
            let level = 0;
            let current = element;
            
            while (current && current.tagName.toLowerCase() !== topTagName.toLowerCase()) {
                if (current.tagName.toLowerCase() === 'li') {
                    level++;
                }
                current = current.parentElement;
            }
            
            return level - 1; // Adjust so top level is 0
        }
        
        // Reset EPUB state
        function resetEpubState() {
            epub = {
                content: {},
                spine: [],
                toc: [],
                metadata: {},
                currentChapterIndex: 0
            };
            
            disableNavigationButtons();
            tocContainer.style.display = 'none';
            bookInfo.innerHTML = '';
        }
        
        // Enable navigation buttons
        function enableNavigationButtons() {
            prevButton.disabled = false;
            nextButton.disabled = false;
            tocButton.disabled = epub.toc.length === 0;
        }
        
        // Disable navigation buttons
        function disableNavigationButtons() {
            prevButton.disabled = true;
            nextButton.disabled = true;
            tocButton.disabled = true;
        }
        
        // Display book metadata
        function displayMetadata() {
            let html = '';
            
            if (epub.metadata.title) {
                html += `<div class="metadata"><strong>Title:</strong> ${epub.metadata.title}</div>`;
            }
            
            if (epub.metadata.creator) {
                html += `<div class="metadata"><strong>Author:</strong> ${epub.metadata.creator}</div>`;
            }
            
            bookInfo.innerHTML = html;
        }
        
        // Navigate to a specific chapter
        function navigateToChapter(index) {
            if (index < 0) {
                index = 0;
            } else if (index >= epub.spine.length) {
                index = epub.spine.length - 1;
            }
            
            epub.currentChapterIndex = index;
            const chapter = epub.spine[index];
            
            if (chapter && epub.content[chapter.id]) {
                displayChapterContent(epub.content[chapter.id]);
            } else {
                contentContainer.innerHTML = '<div class="loading">Unable to load chapter content.</div>';
            }
            
            updateNavigationButtons();
        }
        
        // Display chapter content
        function displayChapterContent(htmlContent) {
            // Create a temporary container to process the HTML
            const tempContainer = document.createElement('div');
            tempContainer.innerHTML = htmlContent;
            
            // Extract body content if available
            const bodyContent = tempContainer.querySelector('body');
            if (bodyContent) {
                tempContainer.innerHTML = bodyContent.innerHTML;
            }
            
            // Remove scripts for security
            tempContainer.querySelectorAll('script').forEach(script => script.remove());
            
            // Fix relative paths in images
            tempContainer.querySelectorAll('img').forEach(img => {
                const src = img.getAttribute('src');
                if (src && !src.startsWith('http')) {
                    const currentChapterPath = epub.spine[epub.currentChapterIndex].href;
                    const currentDir = currentChapterPath.substring(0, currentChapterPath.lastIndexOf('/') + 1);
                    img.setAttribute('src', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=');
                }
            });
            
            // Add basic CSS for readability
            const styleElement = document.createElement('style');
            styleElement.textContent = `
                body { font-family: inherit; }
                p { margin-bottom: 1em; }
                h1, h2, h3, h4, h5, h6 { margin: 1em 0 0.5em; }
                img { max-width: 100%; height: auto; }
            `;
            tempContainer.prepend(styleElement);
            
            // Set the content
            contentContainer.innerHTML = '';
            contentContainer.appendChild(tempContainer);
        }
        
        // Update navigation buttons state
        function updateNavigationButtons() {
            prevButton.disabled = epub.currentChapterIndex <= 0;
            nextButton.disabled = epub.currentChapterIndex >= epub.spine.length - 1;
        }
        
        // Navigate to the previous chapter
        function navigateToPreviousChapter() {
            navigateToChapter(epub.currentChapterIndex - 1);
        }
        
        // Navigate to the next chapter
        function navigateToNextChapter() {
            navigateToChapter(epub.currentChapterIndex + 1);
        }
        
        // Toggle table of contents
        function toggleTableOfContents() {
            if (tocContainer.style.display === 'none' || !tocContainer.style.display) {
                tocContainer.style.display = 'block';
                renderTableOfContents();
            } else {
                tocContainer.style.display = 'none';
            }
        }
        
        // Render table of contents
        function renderTableOfContents() {
            tocList.innerHTML = '';
            
            if (epub.toc.length === 0) {
                tocList.innerHTML = '<li>No table of contents available</li>';
                return;
            }
            
            epub.toc.forEach(item => {
                const li = document.createElement('li');
                li.className = 'toc-item';
                li.textContent = item.label;
                li.style.paddingLeft = `${item.level * 15}px`;
                li.addEventListener('click', () => {
                    navigateToChapter(item.spineIndex);
                    tocContainer.style.display = 'none';
                });
                tocList.appendChild(li);
            });
        }
        
        // Function to toggle navbar visibility
        function toggleNavbar() {
            navbar.classList.toggle('visible');
            
            // Auto-hide navbar after a few seconds
            if (navbar.classList.contains('visible')) {
                setTimeout(() => {
                    navbar.classList.remove('visible');
                }, 3000);
            }
        }
        
        // Show TOC panel
        function showTocPanel() {
            tocPanel.classList.add('visible');
            panelOverlay.classList.add('visible');
            renderMobileToc();
        }
        
        // Hide TOC panel
        function hideTocPanel() {
            tocPanel.classList.remove('visible');
            panelOverlay.classList.remove('visible');
        }
        
        // Show settings panel
        function showSettingsPanel() {
            settingsPanel.classList.add('visible');
            panelOverlay.classList.add('visible');
        }
        
        // Hide settings panel
        function hideSettingsPanel() {
            settingsPanel.classList.remove('visible');
            panelOverlay.classList.remove('visible');
        }
        
        // Close all panels
        function closeAllPanels() {
            hideTocPanel();
            hideSettingsPanel();
        }
        
        // Render TOC for mobile
        function renderMobileToc() {
            tocContent.innerHTML = '';
            
            if (epub.toc.length === 0) {
                tocContent.innerHTML = '<p>No table of contents available</p>';
                return;
            }
            
            epub.toc.forEach(item => {
                const div = document.createElement('div');
                div.className = 'toc-item';
                div.textContent = item.label;
                div.style.paddingLeft = `${item.level * 15}px`;
                div.style.padding = '10px 0';
                div.style.borderBottom = '1px solid #eee';
                div.addEventListener('click', () => {
                    navigateToChapter(item.spineIndex);
                    hideTocPanel();
                });
                tocContent.appendChild(div);
            });
        }
        
        // Show progress indicator
        function showProgress() {
            const progress = Math.round(((epub.currentChapterIndex + 1) / epub.spine.length) * 100);
            progressIndicator.textContent = `${progress}%`;
            progressIndicator.classList.add('visible');
            
            setTimeout(() => {
                progressIndicator.classList.remove('visible');
            }, 2000);
        }
        
        // Decrease font size
        function decreaseFontSize() {
            if (currentFontSize > 70) {
                currentFontSize -= 10;
                updateFontSize();
            }
        }
        
        // Increase font size
        function increaseFontSize() {
            if (currentFontSize < 200) {
                currentFontSize += 10;
                updateFontSize();
            }
        }
        
        // Update font size
        function updateFontSize() {
            fontSizeValue.textContent = `${currentFontSize}%`;
            contentContainer.style.fontSize = `${currentFontSize}%`;
        }
        
        // Set theme
        function setTheme(theme) {
            // Remove current theme class
            document.body.classList.remove('light-theme', 'sepia-theme', 'dark-theme');
            
            // Add new theme class
            document.body.classList.add(`${theme}-theme`);
            
            // Update active theme option
            themeOptions.forEach(option => {
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            currentTheme = theme;
        }

        // Override the original navigate functions to include progress display
        const originalNavigateToChapter = navigateToChapter;
        navigateToChapter = function(index) {
            originalNavigateToChapter(index);
            showProgress();
            
            // Update navbar title
            if (epub.metadata.title) {
                navbarTitle.textContent = epub.metadata.title;
            }
        };

        // Function to return to home/welcome screen
        function returnToHome() {
            // Hide reader container
            readerContainer.style.display = 'none';
            
            // Show welcome screen
            welcomeScreen.style.display = 'flex';
            
            // Reset content display
            contentContainer.innerHTML = '<div class="loading">Upload an EPUB file to start reading</div>';
            
            // Close any open panels
            closeAllPanels();
            
            // Hide navbar if visible
            navbar.classList.remove('visible');
        }
    </script>
</body>
</html>